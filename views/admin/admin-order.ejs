<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <title>Order Management</title>
  <style>
    /* Custom CSS for a more modern look */
    .status-badge {
      @apply px-3 py-1 rounded-full text-xs font-medium;
    }

    .status-pending {
      @apply bg-yellow-100 text-yellow-800;
    }

    .status-processing {
      @apply bg-blue-100 text-blue-800;
    }

    .status-shipped {
      @apply bg-indigo-100 text-indigo-800;
    }

    .status-delivered {
      @apply bg-green-100 text-green-800;
    }

    .status-cancelled {
      @apply bg-red-100 text-red-800;
    }

    .status-returned {
      @apply bg-purple-100 text-purple-800;
    }

    .order-action-btn {
      @apply px-4 py-2 rounded-md text-sm font-medium transition duration-200 ease-in-out;
    }

    .order-action-view {
      @apply bg-blue-500 hover:bg-blue-700 text-white;
    }

    .order-action-edit {
      @apply bg-yellow-500 hover:bg-yellow-700 text-gray-800;
    }

    .order-action-delete {
      @apply bg-red-500 hover:bg-red-700 text-white;
    }

    /* Add a subtle gradient to the header row */
    thead {
      background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
      /* Light gray gradient */
    }

    th {
      color: #4b5563;
      /* Darker gray text */
    }
  </style>
</head>
<%- include('../partials/admin/header.ejs') %>

  <body class="bg-gray-100">

    <div class="container mx-auto mt-16 p-6">

      <!-- Order Management Header -->
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold text-gray-800">
          <i class="fas fa-clipboard-list mr-2"></i> Order Management
        </h1>
        <a href="/admin/dashboard"
          class="bg-gray-200 hover:bg-gray-300 text-gray-700 order-action-btn rounded-full"><i
            class="fas fa-arrow-left mr-2"></i>Back to Dashboard</a>
      </div>

      <!-- Order Table -->
      <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Order ID
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Image
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Address
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Total Quantity
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Total Amount
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Payment
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Status
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% order.forEach(order => { %>
              <%
                let totalQuantity = 0;
                let totalAmount = 0;
                let firstProductImage = '';

                // Find the first product with an image to display
                if (order.orderedItem && order.orderedItem.length > 0) {
                  for (const item of order.orderedItem) {
                    if (item.product && item.product.productImage && item.product.productImage.length > 0) {
                      firstProductImage = item.product.productImage[0];
                      break;
                    }
                  }
                }

                // Calculate totals
                order.orderedItem.forEach(item => {
                  totalQuantity += item.quantity || 0;
                  totalAmount += (item.price || 0) * (item.quantity || 0);
                });

                // Determine overall status based on items (Simplified)
                let statusClass = 'status-pending'; // Default
                let statusText = order.status || 'Pending'; // Use order.status if it exists
                switch (order.status) {
                  case 'Processing':
                    statusClass = 'status-processing';
                    break;
                  case 'Shipped':
                    statusClass = 'status-shipped';
                    break;
                  case 'Delivered':
                    statusClass = 'status-delivered';
                    break;
                  case 'Cancelled':
                    statusClass = 'status-cancelled';
                    break;
                  case 'Returned':
                    statusClass = 'status-returned';
                    break;
                  default:
                    statusClass = 'status-pending';
                }
                %>
              <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">#<%= order._id %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                      <% if (firstProductImage) { %>
                      <img class="h-10 w-10 rounded-full object-cover"
                        src="/uploads/re-image/<%= firstProductImage %>" alt="Product Image">
                      <% } else { %>
                      <img class="h-10 w-10 rounded-full object-cover" src="/images/placeholder.png"
                        alt="Product Image Placeholder">
                      <% } %>
                    </div>

                  </div>
                  <td class="p-4 text-gray-900">
                    <p>
                        <%= order.deliveryAddress.length > 0 
                            ? `${order.deliveryAddress[0].name}, ${order.deliveryAddress[0].city}, ${order.deliveryAddress[0].state}` 
                            : 'Address not available' %>
                    </p>
                </td>
                
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900"><%= totalQuantity %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">â‚¹<%= totalAmount.toFixed(2) %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900"><%= order.paymentMethod || 'Not specified' %></div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="<%= statusClass %> status-badge"><%= statusText %></span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <a href="/admin/orderDetails/<%= order._id %>" class="order-action-btn order-action-view"><i
                      class="fas fa-eye mr-1"></i> View</a>
                 
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>

    </div>

  </body>

</html>